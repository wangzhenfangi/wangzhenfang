# 项目总结	



# 项目搭建

搭建一个总父项目

mingrui-shop-parent      

搭建四个子父项目

mingrui-shop-basics         注册中心 网关

mingrui-shop-commons    公共类 或工具类

mingrui-shop-services  实现类 和 mapper

mingrui-shop-services-api 接口 和实体类



pom.xml  

```java
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
		http://maven.apache.org/xsd/maven-4.0.0.xsd">
 <modelVersion>4.0.0</modelVersion>
 <groupId>com.baidu</groupId>
 <artifactId>mingrui-shop-parent</artifactId>
 <version>1.0-SNAPSHOT</version>
 <!--父级项目不需要打包所有packging的类型为pom-->
 <packaging>pom</packaging>
 <properties>
   <!--项目构建编码-->
   <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
   <project.reporting.outputEncoding>UTF-
8</project.reporting.outputEncoding>
   <!--声明JDK版本-->
   <java.version>1.8</java.version>
   <!--spring cloud 版本.注意此版本是建立在boot2.2.2版本上的-->
   <mr.spring.cloud.version>Hoxton.SR1</mr.spring.cloud.version>
 </properties>
 <!--boot 版本-->
 <parent>
   <groupId>org.springframework.boot</groupId>
   <artifactId>spring-boot-starter-parent</artifactId>
   <version>2.3.1.RELEASE</version>
   <!--始终从仓库中获取，不从本地路径获取-->
   <relativePath />
 </parent>
 <dependencies>
   <!-- 集成commons工具类 -->
   <dependency>
     <groupId>org.apache.commons</groupId>
     <artifactId>commons-lang3</artifactId>
   </dependency>
   <!-- 集成lombok 框架 -->
   <dependency>
     <groupId>org.projectlombok</groupId>
     <artifactId>lombok</artifactId>
   </dependency>
   <!--junit测试-->
   <dependency>
     <groupId>junit</groupId>
     <artifactId>junit</artifactId>
   </dependency>
   <!-- SpringBoot整合eureka客户端 -->
   <dependency>
     <groupId>org.springframework.cloud</groupId>
     <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
   </dependency>
   <!--boot 测试模块-->
   <dependency>
     <groupId>org.springframework.boot</groupId>
     <artifactId>spring-boot-starter-test</artifactId>
     <scope>test</scope>
   </dependency>
 </dependencies>
 <!-- 项目依赖,子级模块可以继承依赖-->
 <dependencyManagement>
   <dependencies>
     <!--cloud 依赖-->
     <dependency>
       <groupId>org.springframework.cloud</groupId>
       <artifactId>spring-cloud-dependencies</artifactId>
       <version>${mr.spring.cloud.version}</version>
       <type>pom</type>
       <!--解决maven单继承的问题-->
       <scope>import</scope>
     </dependency>
   </dependencies>
 </dependencyManagement>
 <!-- 注意： 这里必须要添加， 否者各种依赖有问题 -->
 <repositories>
   <repository>
     <id>spring-milestones</id>
     <name>Spring Milestones</name>
     <url>https://repo.spring.io/libs-milestone</url>
     <snapshots>
       <enabled>false</enabled>
     </snapshots>
   </repository>
 </repositories>
</project>
```

# 





# 品牌项目总结	

思路

#### 修改功能

1.通过前台传来的id或实体类

2.执行普通的修改操作

3.先通过brandId删除中间表的数据

4.批量新增 / 新增

4.1得到分类集合字符串

4.2判断分类集合字符串中是否包含, （包含批量不包含普通新增）

4.3多个分类 --> 批量新增

5.普通单个新增

#### 删除功能

1.根据前台传来的id做普通删除

2.根据brandid通过Example删除分类关系表中的数据



#### 新增功能

１.将前台传来的数据用DTO接收然后用工具类的．copyProperties方法转成实体类、

２.通过工具类PinyinUtil.getUpperCase方法把汉字转换成拼音String.valueOf将string类型的字符串转换为ｃｈａｒ类型的数组【】然后用toCharArray方法进行字符串截取　实现汉字识别和拼音首字母的截取

３.执行普通的品牌新增

４批量分类新增 / 新增

4.1得到分类集合字符串

4.2判断分类集合字符串中是否包含, （包含批量不包含普通新增）

4.3多个分类 --> 批量新增

5.普通单个分类新增

#### 查询功能

１分页

１.１通过分页工具类PageHelper.startPage方法把ｐａｇｅ和ｒｏｗｓ属性传进去实现分页功能

２.排序簡化版

２.２判断排序字段是否为空

２.３通过分页工具类PageHelper.orderBy方法把封装好的order传入进去（封装使用了Boolean．　				valueOf（）和三目运算）　实现排序功能

３.条件模糊查询
３.１通过copyProperties把ＤＴＯ转换为实体类　

３.２通过Example（实体类）创建条件查询

​       example.createCriteria().andLike(内放的是模糊查询的字段“％”＋需要用％和加号拼接＋“％”)

​		执行selectByExample（）语句

４．将查询结果放入ＰａｇｅＩｎｆｏ＜＞集合内　泛型实体类类型　

５.并将的ｌｉｓｔ集合放入this.setResultSuccess（）内返回给前台　

### 后台

#### mingrui-shop-service-api

com.baidu.shop.entity

先写BrandEntity实体类

```java
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;

@Table(name = "tb_brand")
@Data
public class BrandEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Integer id;

    private String name;

    private String image;

    private Character letter;
}
```

#### mingrui-shop-service-api

继承BaseDTO

```java
package com.baidu.shop.dto;

import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotNull;

@ApiModel(value = "品牌DTO")
@Data
public class BrandDTO extends BaseDTO {

    @ApiModelProperty(value = "品牌主键",example = "1")
    @NotNull(message = "主键不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "品牌名称")
    @NotNull(message = "品牌名称不能为空",groups = {MingruiOperation.Update.class})
    private String name;

    @ApiModelProperty(value = "品牌 logo")
    private String image;

    @ApiModelProperty(value = "品牌首字母")
    private Character letter;

    @ApiModelProperty(value = "品牌id集合")
    private String categories;
}

```

#### mingrui-shop-service-api

添加BrandService接口

```java
package com.baidu.shop.service;

import com.alibaba.fastjson.JSONObject;
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.BrandDTO;
import com.baidu.shop.entity.BrandEntity;
import com.baidu.shop.utils.JSONUtil;
import com.github.pagehelper.PageInfo;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.*;

@Api(tags = "品牌接口")
public interface BrandService {

    @ApiOperation(value = "获取品牌信息")
    @GetMapping(value = "brand/list")
    Result<PageInfo<BrandEntity>> getBrandInfo(BrandDTO brandDTO);

    @ApiOperation(value = "品牌新增")
    @PostMapping(value = "brand/save")
    Result<JSONObject> saveBrandInfo(@RequestBody BrandDTO brandDTO);

    @ApiOperation(value = "品牌修改")
    @PutMapping(value = "brand/save")
    Result<JSONObject> editBrandInfo(@RequestBody BrandDTO brandDTO);

    @ApiOperation(value = "品牌删除")
    @DeleteMapping(value = "brand/deleteId")
    Result<JSONObject> deleteBrandInfo(Integer id);
}

```

#### mingrui-shop-service-xxx

com.baidu.shop.serviceImpl包下创建实现类BrandServiceImpl

```java
package com.baidu.shop.service.impl;

import com.alibaba.fastjson.JSONObject;
import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.BrandDTO;
import com.baidu.shop.entity.BrandEntity;
import com.baidu.shop.entity.CategoryBrandEntity;
import com.baidu.shop.entity.CategoryEntity;
import com.baidu.shop.mapper.BrandMapper;
import com.baidu.shop.mapper.CategoryBrandMapper;
import com.baidu.shop.service.BrandService;
import com.baidu.shop.utils.BaiduBeanUtil;
import com.baidu.shop.utils.JSONUtil;
import com.baidu.shop.utils.PinyinUtil;
import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.RestController;
import tk.mybatis.mapper.entity.Example;
import javax.annotation.Resource;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.stream.Collectors;

@RestController
public class BrandServiceImpl extends BaseApiService implements BrandService {

    @Autowired
    private BrandMapper brandMapper;

    @Autowired
    private CategoryBrandMapper categoryBrandMapper;

    @Transactional
    @Override
    public Result<JSONObject> deleteBrandInfo(Integer id) {
        brandMapper.deleteByPrimaryKey(id);

        this.deleteCategoryByBrand(id);

        return this.setResultSuccess();
    }

    @Transactional
    @Override
    public Result<JSONObject> editBrandInfo(BrandDTO brandDTO) {
        BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDTO, BrandEntity.class);
        brandEntity.setLetter(PinyinUtil.getUpperCase(String.valueOf(brandEntity.getName().toCharArray()[0]), false).toCharArray()[0]);
        brandMapper.updateByPrimaryKeySelective(brandEntity);

        this.deleteCategoryByBrand(brandEntity.getId());

        this.insertCategoryBrandList(brandDTO.getCategories(),brandEntity.getId());
        return this.setResultSuccess();
    }

    @Transactional
    @Override
    public Result<JSONObject> saveBrandInfo(BrandDTO brandDTO) {
        BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDTO,BrandEntity.class);

        //处理品牌首字母
        brandEntity.setLetter(PinyinUtil.getUpperCase(String.valueOf(brandEntity.getName().toCharArray()[0]),false).toCharArray()[0]);

        brandMapper.insertSelective(brandEntity);

        this.insertCategoryBrandList(brandDTO.getCategories(),brandEntity.getId());

        return this.setResultSuccess();
    }



    @Override
    public Result<PageInfo<BrandEntity>> getBrandInfo(BrandDTO brandDTO) {

        //分页
        PageHelper.startPage(brandDTO.getPage(),brandDTO.getRows());

        if(!StringUtils.isEmpty(brandDTO.getSort())){
            //String order = "";
            //if (Boolean.valueOf(brandDTO.getOrder())){
            //    order = "desc";
            //}else{
            //    order = "asc";
            //}
            //PageHelper.orderBy(brandDTO.getSort()+ " " + (Boolean.valueOf(brandDTO.getOrder())? "desc" : "asc"));
            PageHelper.orderBy(brandDTO.getOrderBy());
        }

        Example example = new Example(BrandEntity.class);
        example.createCriteria().andLike("name","%"+brandDTO.getName()+"%");

        List<BrandEntity> brandEntities = brandMapper.selectByExample(example);
        PageInfo<BrandEntity> pageInfo  = new PageInfo<>(brandEntities);

        return this.setResultSuccess(pageInfo);
    }

    private void insertCategoryBrandList(String categories,Integer brandId){
        if(StringUtils.isEmpty(categories))throw new RuntimeException("分类信息不能为空");
        //判断分类集合中是否包含逗号","
        if(categories.contains(",")){
            categoryBrandMapper.insertList(
                    Arrays.asList(categories.split(","))
                            .stream()
                            .map(categoryIdStr -> new CategoryBrandEntity(Integer.valueOf(categoryIdStr)
                                    ,brandId))
                            .collect(Collectors.toList())
            );
        }else{
            CategoryBrandEntity categoryBrandEntity = new CategoryBrandEntity();
            categoryBrandEntity.setBrandId(brandId);
            categoryBrandEntity.setCategoryId(Integer.valueOf(categories));

            categoryBrandMapper.insertSelective(categoryBrandEntity);
        }
    }

    private void deleteCategoryByBrand(Integer brandId){
        Example example = new Example(CategoryBrandEntity.class);
        example.createCriteria().andEqualTo("brandId",brandId);
        categoryBrandMapper.deleteByExample(example);
    }
}

```

#### mingrui-shop-service-api-xxx

com.baidu.shop.entity

添加中间表CategoryBrandEntity

```java
package com.baidu.shop.entity;


import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import javax.persistence.Table;

@Table(name = "tb_category_brand")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class CategoryBrandEntity {

    private Integer categoryId;

    private Integer brandId;

}

```

mingrui-shop-common-core


 添加分页排序的字段

com.baidu.shop.base包下中添加BaseDTO

```java
package com.baidu.shop.base;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

@Data
@ApiModel(value = "BaseDTO用于数据传输,其他dto需要继承此类")
public class BaseDTO {

    @ApiModelProperty(value = "当前页",example = "1")
    private Integer page;

    @ApiModelProperty(value = "每页显示多少条",example = "5")
    private Integer rows;

    @ApiModelProperty(value = "排序字段")
    private String sort;

    @ApiModelProperty(value = "是否升序")
    private String order;

    public String getOrderBy(){
        return sort + " " + (Boolean.valueOf(order) ? "desc" : "asc");
    }
}

```

## 查询

在前台创建	MrBrand.vue

```js
    <!-- 表格组件 -->
    <v-data-table
      :headers="headers"
      :items="desserts"
      :pagination.sync="pagination"
      :total-items="total"
      class="elevation-1"
    >
      <template slot="items" slot-scope="props">
        <td class="text-xs-center">{{ props.item.id }}</td>
        <td class="text-xs-center">{{ props.item.name }}</td>
        <td class="text-xs-center">
          <!-- src 是html标签的属性 :src="vue的属性" -->
          <img width="100px" :src="props.item.image" />
        </td>
        <td class="text-xs-center">{{ props.item.letter }}</td>
        <td class="text-xs-center">
          <v-btn flat icon color="blue" @click="editData(props.item)">
            <v-icon>edit</v-icon>
          </v-btn>
          <v-btn flat icon color="red" @click="deleteId(props.item.id)">
            <v-icon>delete</v-icon>
          </v-btn>
        </td>
      </template>
    </v-data-table>
  </v-card>
</template>
<script>
import MrBrandForm from './MrBrandForm';
export default {
  name: "MrBrand",
  components:{
    MrBrandForm
  },
  data() {
    return {
      brandDetail:{},
      isEdit:false,
      pagination: {},
      dialog:false,
      total: 0,
      search: "",
      headers: [
        {
          text: "id",
          align: "center",
          value: "id",
        },
        {
          text: "品牌名称",
          align: "center",
          value: "name",
        },
        {
          text: "品牌logo",
          width:"50px",
          align: "center",
          value: "image",
        },
        {
          text: "首字母",
          align: "center",
          value: "letter",
        },
        {
          text: "操作",
          align: "center",
          sortable: false,
          value: "id",
        },
      ],
      desserts: [],
    };
  },
  mounted() {
    this.getTableData();
  },
  methods: {
    getTableData() {
      this.$http
        .get("/brand/list", {
          params: {
            page: this.pagination.page,
            rows: this.pagination.rowsPerPage,
            sort: this.pagination.sortBy,
            order: this.pagination.descending,
            name: this.search
          },
        })
        .then((resp) => {
          this.desserts = resp.data.data.list;
          this.total = resp.data.data.total;
        })
        .catch((error) => console.log(error));
    }
  },
  watch: {
    pagination() {
      this.getTableData();
    }
  }
};
</script>
```

### 在mingrui-shop-service-api-xxx下新建BrandService

```java
    @ApiOperation(value = "获取品牌信息")
    @GetMapping(value = "brand/list")
    Result<PageInfo<BrandEntity>> getBrandInfo(BrandDTO brandDTO);
```

### 在mapper包下新建BrandMapper

```java
package com.baidu.shop.mapper;

import com.baidu.shop.entity.BrandEntity;
import tk.mybatis.mapper.common.Mapper;

public interface BrandMapper extends Mapper<BrandEntity> {
}
```

### 在mingrui-shop-service-xxx下新建BrandService接口的实现类BrandServiceImpl

```java
    @Override
    public Result<PageInfo<BrandEntity>> getBrandInfo(BrandDTO brandDTO) {

        //分页
        PageHelper.startPage(brandDTO.getPage(),brandDTO.getRows());

        if(!StringUtils.isEmpty(brandDTO.getSort())){
            //String order = "";
            //if (Boolean.valueOf(brandDTO.getOrder())){
            //    order = "desc";
            //}else{
            //    order = "asc";
            //}
            //PageHelper.orderBy(brandDTO.getSort()+ " " + (Boolean.valueOf(brandDTO.getOrder())? "desc" : "asc"));
            PageHelper.orderBy(brandDTO.getOrderBy());
        }

        Example example = new Example(BrandEntity.class);
        example.createCriteria().andLike("name","%"+brandDTO.getName()+"%");

        List<BrandEntity> brandEntities = brandMapper.selectByExample(example);
        PageInfo<BrandEntity> pageInfo  = new PageInfo<>(brandEntities);

        return this.setResultSuccess(pageInfo);
    }
```

## 新增

###  在utils包下新建BaiduBeanUtil

```java
package com.baidu.shop.utils;

import com.sun.org.apache.bcel.internal.generic.RETURN;
import org.springframework.beans.BeanUtils;

public class BaiduBeanUtil<T> {
    public static <T> T copyProperties(Object source,Class<T> clazz){

        try {
            T t = clazz.newInstance();
            BeanUtils.copyProperties(source,t);
            return t;
        } catch (InstantiationException e) {
            e.printStackTrace();
        } catch (IllegalAccessException e) {
            e.printStackTrace();
        }
        return null;
    }
}
```

### BrandDTO

```java
    @ApiModelProperty(value = "品牌id集合")
    private String categories;
```

### entity包下新建中间表CategoryBrandEntity

用于保存商品分类和品牌分类的id

通过这张表让他们连接起来

```java
package com.baidu.shop.entity;


import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import javax.persistence.Table;

@Table(name = "tb_category_brand")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class CategoryBrandEntity {

    private Integer categoryId;

    private Integer brandId;
}
```

### BrandService下写入新增接口

```java
    @ApiOperation(value = "品牌新增")
    @PostMapping(value = "brand/save")
    Result<JSONObject> saveBrandInfo(@RequestBody BrandDTO brandDTO);
```

### 在mapper包下新建CategoryBrandMapper

```java
public interface CategoryBrandMapper extends Mapper<CategoryBrandEntity>,InsertListMapper<CategoryBrandEntity> {     		

}
```

### BrandServiceImpl实现类下

```java
    @Transactional
    @Override
    public Result<JSONObject> saveBrandInfo(BrandDTO brandDTO) {
        BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDTO,BrandEntity.class);

        //处理品牌首字母
        brandEntity.setLetter(PinyinUtil.getUpperCase(String.valueOf(brandEntity.getName().toCharArray()[0]),false).toCharArray()[0]);

        brandMapper.insertSelective(brandEntity);

        this.insertCategoryBrandList(brandDTO.getCategories(),brandEntity.getId());

        return this.setResultSuccess();
    }
```

###  封装工具类的方法

```java
private void insertCategoryBrandList(String categories,Integer brandId){
        if(StringUtils.isEmpty(categories))throw new RuntimeException("分类信息不能为空");
        //判断分类集合中是否包含逗号","
        if(categories.contains(",")){
            categoryBrandMapper.insertList(
                    Arrays.asList(categories.split(","))
                            .stream()
                            .map(categoryIdStr -> new CategoryBrandEntity(Integer.valueOf(categoryIdStr)
                                    ,brandId))
                            .collect(Collectors.toList())
            );
        }else{
            CategoryBrandEntity categoryBrandEntity = new CategoryBrandEntity();
            categoryBrandEntity.setBrandId(brandId);
            categoryBrandEntity.setCategoryId(Integer.valueOf(categories));

            categoryBrandMapper.insertSelective(categoryBrandEntity);
        }
    }
```

```java
	private void deleteCategoryByBrand(Integer brandId){
        Example example = new Example(CategoryBrandEntity.class);
        example.createCriteria().andEqualTo("brandId",brandId);
        categoryBrandMapper.deleteByExample(example);
    }
```

## 修改

### mingrui-shop-service-api-xxx下添加修改接口

###  CategoryService

```java
    @ApiOperation(value = "通过id修改")
    @PutMapping(value = "/category/edit")
    Result<JSONObject> editCategoryByPid(@Validated({MingruiOperation.Update.class}) @RequestBody 		CategoryEntity categoryEntity);
```

### CategoryMapper写自定义查询语句

```
package com.baidu.shop.mapper;

import com.baidu.shop.entity.CategoryEntity;
import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.common.Mapper;

import java.util.List;

public interface CategoryMapper extends Mapper<CategoryEntity> {

    @Select(value = "select id,name from tb_category where id in (select category_id from tb_category_brand where brand_id=#{brandId})")
    List<CategoryEntity> getCategoryByBrandId(Integer brandId);
}
```

### CategoryServiceImpl

```java
    @Override
    public Result<List<CategoryEntity>> getCategoryByBrandId(Integer brandId) {
        List<CategoryEntity> list = categoryMapper.getCategoryByBrandId(brandId);
        return this.setResultSuccess(list);
    }
```

### BrandService

```java
    @ApiOperation(value = "品牌修改")
    @PutMapping(value = "brand/save")
    Result<JSONObject> editBrandInfo(@RequestBody BrandDTO brandDTO);
```

### BrandServiceImpl

```java
    @Transactional
    @Override
    public Result<JSONObject> editBrandInfo(BrandDTO brandDTO) {
        BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDTO, BrandEntity.class);
        brandEntity.setLetter(PinyinUtil.getUpperCase(String.valueOf(brandEntity.getName().toCharArray()[0]), false).toCharArray()[0]);
        brandMapper.updateByPrimaryKeySelective(brandEntity);

        this.deleteCategoryByBrand(brandEntity.getId());

        this.insertCategoryBrandList(brandDTO.getCategories(),brandEntity.getId());
        return this.setResultSuccess();
    }
```







------



# 分类项目总结

#### 删除功能

------

![hhh](C:\Users\86158\Desktop\桌面文件夾\hhh.png)

------

#### 修改功能

普通的修改没有逻辑

１．接受前台传来的entity

２.执行updateByPrimaryKeySelective

３.返回this.setResultSuccess()方法

​	

#### 新增功能

１.根据传来的值判断当前节点ｉｓParent是否为１如果为０则修改为１

２.ｎｅｗ实体类把１赋进去把parentid也Fiji去　　执行修改操作

３.再执行新增操作

４.无返回值

#### 查询功能

１.将前台传来的id存到实体类中

２.将ｐｉｄ存到.setParentId(pid);内

３.执行select(categoryEntity);方法

５.返回this.setResultSuccess(list);



# 规格参数

### 查询

通过分类id查询数据

判断cid不能为空

用specGroupDTO.getCid()做条件查询分类

查询成功后通过this.成功回调函数返回集合数据

### 新增

普通新增

把前台传过来的值通过BaiduBeanUtil.copyProperties函数转换成实体类

执行insertSelective方法

返回成功回调函数

### 删除

普通删除

接收前台传来的id属性

执行deleteByPrimaryKey方法

返回成功回调函数

### 修改

普通修改

把前台传过来的值通过BaiduBeanUtil.copyProperties函数转换成实体类

执行updateByPrimaryKeySelective方法

返回成功回调函数

##  查询

#### mingrui-shop-service-api-xxx

com.baidu.shop.entity新建：SpecGroupEntity

```
import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;

@Table(name = "tb_spec_group")
@Data
public class SpecGroupEntity {
    @Id
    private Integer id;

    private Integer cid;

    private String name;
}
```

com.baidu.shop.dto新建：SpecGroupDto

```
import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;

@ApiModel(value = "规格分组")
@Data
public class SpecGroupDto extends BaseDTO {

    @ApiModelProperty(value = "主键",example = "1")
    @NotNull(message = "主键不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "类型id",example = "1")
    @NotNull(message = "类型id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid;

    @ApiModelProperty(value = "规格组名称",example = "1")
    @NotEmpty(message = "规格组名称不能为空",groups = {MingruiOperation.Add.class})
    private String name;
}
```

com.baidu.shop.service新建：

SpecGroupService

```
package com.baidu.shop.service;

import com.baidu.shop.base.Result;
import com.baidu.shop.dto.SpecGroupDto;
import com.baidu.shop.entity.SpecGroupEntity;
import com.google.gson.JsonObject;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiModelProperty;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@Api(value ="规格组接口")
public interface SpecGroupService {

    @ApiModelProperty(value = "规格组查询")
    @GetMapping(value = "specGroup/getSpecGroupInfo")
    Result<List<SpecGroupEntity>> getSpecGroupInfo(SpecGroupDto specGroupDto);
}
```

#### mingrui-shop-service-xxx

com.baidu.shop.mapper新建：

SpecGroupMapper

```
package com.baidu.shop.mapper;

import com.baidu.shop.entity.SpecGroupEntity;
import tk.mybatis.mapper.common.Mapper;

public interface SpecGroupMapper extends Mapper<SpecGroupEntity> {
}

```

com.baidu.shop.service.impl新建SpecGroupServiceImpl

```
import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.SpecGroupDTO;
import com.baidu.shop.entity.SpecGroupEntity;
import com.baidu.shop.mapper.SpecGroupMapper;
import com.baidu.shop.service.SpecificationService;
import com.baidu.shop.utils.ObjectUtil;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.RestController;
import tk.mybatis.mapper.entity.Example;
import javax.annotation.Resource;
import java.util.List;

@RestController
public class SpecGroupServiceImpl extends BaseApiService implements SpecGroupService {

    @Resource
    private SpecGroupMapper specGroupMapper;
    
    //规格组查询
    @Override
    public Result<List<SpecGroupEntity>> getSpecGroupInfo(SpecGroupDto specGroupDto) {
        Example example = new Example(SpecGroupEntity.class);

        if (ObjectUtil.isNotNull(specGroupDto.getCid()))
                example
                .createCriteria()
                .andEqualTo("cid", BaiduBeanUtil.copyProperties(specGroupDto,SpecGroupEntity.class).getCid());

        List<SpecGroupEntity> specGroupExample = specGroupMapper.selectByExample(example);
        return this.setResultSuccess(specGroupExample);
    }
}
```

###  页面

加载分类信息

index.js line:29

```
route("/item/specification",'/item/specification/Specification',"Specification"),
```

 specification/Specification.vue

```
<v-tree url="/specGroup/getSpecGroupInfo" :isEdit="false" @handleClick="handleClick"/>
```

查询

SpecGroup.vue

```
loadData(){
          this.$http.get("/specGroup/getSpecGroupInfo",{
              params:{
                  cid:this.cid
              }
          })
          .then((resp) => {
              this.groups = resp.data.data;
          })
          .catch(() => {
              this.groups = [];
          })
      },
```

##  新增,删除,修改

#### mingrui-shop-service-api-xxx

com.baidu.shop.service：SpecGroupService

```
@ApiModelProperty(value = "新增规格组")
@PostMapping(value = "specGroup/save")
Result<JsonObject> saveSpecGroup(@RequestBody SpecGroupDto specGroupDto);

@ApiModelProperty(value = "修改规格组")
@PutMapping(value = "specGroup/save")
Result<JsonObject> editSpecGroup(@RequestBody SpecGroupDto specGroupDto);

@ApiModelProperty(value = "删除规格组")
@DeleteMapping("specGroup/delete/{id}")
Result<JsonObject> delSpecRoupById(@PathVariable Integer id);
```

mingrui-shop-service-xxx

com.baidu.shop.service.impl：

SpecGroupServiceImpl

```
//规格组新增
@Transactional
@Override
public Result<JsonObject> saveSpecGroup(SpecGroupDto specGroupDto) {
    specGroupMapper.insertSelective(BaiduBeanUtil.copyProperties(specGroupDto,SpecGroupEntity.class));
    return this.setResultSuccess();
}

//规格组修改
@Override
public Result<JsonObject> editSpecGroup(SpecGroupDto specGroupDto) {
    specGroupMapper.updateByPrimaryKeySelective(BaiduBeanUtil.copyProperties(specGroupDto,SpecGroupEntity.class));
    return this.setResultSuccess();
}

//规格组删除

@Override
public Result<JsonObject> delSpecRoupById(Integer id) {
    //删除规格组之前要先判断一下当前规格组下是否有规格参数
    //true : 不能被删除
    //false -->
    Example example = new Example(SpecParamEntity.class);
    example.createCriteria().andEqualTo("groupId",id);
    List<SpecParamEntity> specParamEntities = specParamMapper.selectByExample(example);
    if (specParamEntities.size() >0){
        return this.setResultError("当前规格组有数据不能被删除");
    }

    specGroupMapper.deleteByPrimaryKey(id);
    return this.setResultSuccess();
}
```

### 页面

 SpecGroup.vue

```
save(){
           this.$http({
            method: this.isEdit ? 'put' : 'post',
            url: 'specGroup/save',
            data: this.group
          }).then((resp) => {
            // 关闭窗口
            if(resp.data.code == 200){
                this.show = false;
                this.$message.success("保存成功！");
                this.loadData();
            }
           
          }).catch(() => {
              this.$message.error("保存失败！");
            });
      },
      deleteGroup(id){
          this.$message.confirm("确认要删除分组吗？")
          .then(() => {
            this.$http.delete("/specGroup/delete/ " + id)
                .then((resp) => {
                    if(resp.data.code!=200){
                        this.$message.error(resp.data.message);
                        this.loadData();
                        return
                    }
                    this.loadData();
                    this.$message.success("删除成功")
                })
          })
      },
```

## 

# 商品列表

### 查询

前台

```
<v-btn-toggle mandatory v-model="search.saleable">
<!--将此处改为number类型的值比较好处理-->
<v-btn flat :value="2">
全部
</v-btn>
<v-btn flat :value="0">
上架
</v-btn>
<v-btn flat :value="1">
下架
</v-btn>
</v-btn-toggle>
```





```
  getDataFromApi() {
        this.loading = true;
        this.$http.get('goods/getSpuInfo',{
          params:{
            page:this.pagination.page,
            rows:this.pagination.rowsPerPage,
            sort:this.pagination.sortBy,
            order:this.pagination.descending,
            saleable:this.search.saleable,
            title:this.search.key
          },
         }).then(resp => {
          this.items = resp.data.data;
          //this.totalItems = resp.data.message - 0;
          this.totalItems = parseInt(resp.data.message);
          this.loading = false;
        }).catch(error => console.log(error))
        // setTimeout(() => {
        //   // 返回假数据
        //   this.items = goodsData.slice(0, 4);
        //   this.totalItems = 25;
        //   this.loading = false;
        // }, 300)
      }
```



##### 新建实体类SpuEntity

```
package com.baidu.shop.entity;

import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;
import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;
import java.util.Date;

/**
 * 2 *@ClassName SpuEntity
 * 3 *@Description: TODO
 * 4 *@Author 王振方
 * 5 *@Date 2021/1/5
 *
 * @Version V1.0
 * 7
 **/
@Data
@Table(name = "tb_spu")
public class SpuEntity{

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @ApiModelProperty(value = "spu主鍵",example = "1")
    @NotNull(message = "主键不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "标题")
    @NotEmpty(message = "标题不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private String title;

    private String subTitle;

    @ApiModelProperty(value = "cid1",example = "1")
    @NotNull(message = "cid1不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private Integer cid1;

    @ApiModelProperty(value = "cid2",example = "1")
    @NotNull(message = "cid2不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private Integer cid2;

    @ApiModelProperty(value = "cid3",example = "1")
    @NotNull(message = "cid3不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private Integer cid3;

    @ApiModelProperty(value = "品牌id",example = "1")
    @NotNull(message = "品牌id不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private Integer brandId;

    @ApiModelProperty(value = "是否上架",example = "1")
    @NotNull(message = "上架下架不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private Integer saleable;

    @ApiModelProperty(value = "有效",example = "1")
    @NotNull(message = "有效信息不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private Integer valid;

    private Date createTime;

    private Date lastUpdateTime;



}

```

新建SpuDTO

```
package com.baidu.shop.dto;

import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import io.swagger.annotations.ApiOperation;
import lombok.Data;

import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;
import java.util.Date;
import java.util.List;

/**
 * 2 *@ClassName SpuDTO
 * 3 *@Description: TODO
 * 4 *@Author 王振方
 * 5 *@Date 2021/1/5
 *
 * @Version V1.0
 * 7
 **/
@ApiModel(value = "spu数据传输DTO")
@Data
public class SpuDTO extends BaseDTO {
    @ApiModelProperty(value = "主键",example = "1")
    @NotNull(message = "主键不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "标题")
    @NotEmpty(message = "标题不能为空",groups = {MingruiOperation.Add.class})
    private  String title;

    @ApiModelProperty(value = "子标题")
    private String subTitle;

    @ApiModelProperty(value = "1级类目id", example = "1")
    @NotNull(message = "1级类目id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid1;

    @ApiModelProperty(value = "2级类目id", example = "1")
    @NotNull(message = "2级类目id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid2;

    @ApiModelProperty(value = "3级类目id", example = "1")
    @NotNull(message = "3级类目id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid3;

    @ApiModelProperty(value = "商品所属品牌id", example = "1")
    @NotNull(message = "商品所属品牌id不能为空",groups = {MingruiOperation.Add.class})
    private Integer brandId;

    //不需要验证,新增时直接设置默认值
    @ApiModelProperty(value = "是否上架，0下架，1上架", example = "1")
    @NotNull(message = "上架下架不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private Integer saleable;

    //不需要验证,新增时直接设置默认值
    @ApiModelProperty(value = "是否有效，0已删除，1有效", example = "1")
    @NotNull(message = "有效信息不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private Integer valid;

    //不需要验证,新增时直接设置默认值
    @ApiModelProperty(value = "添加时间")
    private Date createTime;
    //不需要验证,新增时直接设置默认值,修改时使用java代码赋值

    @ApiModelProperty(value = "最后修改时间")
    private  Date lastUpdateTime;

    private String categoryName;

    private String brandName;

    @ApiModelProperty(value = "大字段数据")
    private SpuDetailDTO spuDetail;

    @ApiModelProperty(value = "sku属性数据集合")
    private List<SkuDTO> skus;



}

```

新建GoodsService

```
package com.baidu.shop.service;

import com.alibaba.fastjson.JSONObject;
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.SkuDTO;
import com.baidu.shop.dto.SpuDTO;
import com.baidu.shop.entity.SpuDetailEntity;
import com.baidu.shop.entity.SpuEntity;
import com.baidu.shop.validate.group.MingruiOperation;
import com.github.pagehelper.PageInfo;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.models.auth.In;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * 2 *@ClassName GoodsService
 * 3 *@Description: TODO
 * 4 *@Author 王振方
 * 5 *@Date 2021/1/5
 *
 * @Version V1.0
 * 7
 **/
@Api(tags = "商品接口")
public interface GoodsService {

    @ApiOperation(value = "获取spu信息")
    @GetMapping(value = "goods/getSpuInfo")
    public Result<List<SpuDTO>> getSpuInfo(SpuDTO spuDTO);

}

```

新建SpuMapper

#

```
package com.baidu.shop.mapper;


import com.baidu.shop.entity.SpuEntity;
import tk.mybatis.mapper.common.Mapper;

public interface SpuMapper extends Mapper<SpuEntity>{

}
```



修改CategoryMapper

#

```
import com.baidu.shop.entity.CategoryEntity;
import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.additional.idlist.SelectByIdListMapper;
import tk.mybatis.mapper.common.Mapper;
import java.util.List;

//可以通过id集合查询
public interface CategoryMapper extends Mapper<CategoryEntity>,SelectByIdListMapper<CategoryEntity,Integer>{
    @Select(value = "select c.id,c.name from tb_category c where c.id in(selectt.category_id from 					tb_category_brand t where t.brand_id=#{brandId})")
    List<CategoryEntity> getCatesByBrand(Integer brandId);
}

```



实现类GoodsServiceImpl

#

```
package com.baidu.shop.servce.impl;

import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.service.GoodsService;


/**
 * 2 *@ClassName GoodsServiceImpl
 * 3 *@Description: TODO
 * 4 *@Author 王振方
 * 5 *@Date 2021/1/5
 *
 * @Version V1.0
 * 7
 **/

@RestController
public class GoodsServiceImpl extends BaseApiService implements GoodsService {

    @Resource
    private SpuMapper spuMapper;
    @Resource
    private BrandMapper brandMapper;
    @Resource
    private CategoryMapper categoryMapper;


@Override
public Result<List<SpuDTO>> getSpuInfo(SpuDTO spuDTO) {
    //分页
    if(ObjectUtil.isNotNull(spuDTO.getPage()) && ObjectUtil.isNotNull(spuDTO.getRows()))
        PageHelper.startPage(spuDTO.getPage(),spuDTO.getRows());
    Example example = new Example(SpuEntity.class);
    Example.Criteria criteria = example.createCriteria();

    if(!StringUtils.isEmpty(spuDTO.getSort()) && !StringUtils.isEmpty(spuDTO.getOrder())){
        PageHelper.orderBy(spuDTO.getOrderByClause());
    }
    //是否上架
    if(ObjectUtil.isNotNull(BaiduBeanUtil.copyProperties(spuDTO,SpuEntity.class).getSaleable())
            && BaiduBeanUtil.copyProperties(spuDTO,SpuEntity.class).getSaleable() < 2){
        criteria.andEqualTo("saleable",spuDTO.getSaleable());
    }
    //模糊查询
    if(!StringUtils.isEmpty(spuDTO.getTitle())) criteria.andLike("title","%" + spuDTO.getTitle() + "%");

    List<SpuEntity> spuEntities = spuMapper.selectByExample(example);

    List<SpuDTO> spuDTOList = spuEntities.stream().map(spuEntity ->{
        SpuDTO spuDTO1 = BaiduBeanUtil.copyProperties(spuEntity, SpuDTO.class);
        //通过分类id集合查询数据
        List<CategoryEntity> categoryEntities  = categoryMapper.selectByIdList(Arrays.asList(spuEntity.getCid1(), spuEntity.getCid2(), spuEntity.getCid3()));
        //便利集合并且将分类名称用/拼接
        String categoryName  = categoryEntities.stream().map(categoryEntity -> categoryEntity.getName()).collect(Collectors.joining("/"));
        spuDTO1.setCategoryName(categoryName);

        BrandEntity brandEntity = brandMapper.selectByPrimaryKey(spuEntity.getBrandId());
        spuDTO1.setBrandName(brandEntity.getName());

        return spuDTO1;
    }).collect(Collectors.toList());


    PageInfo<SpuEntity>  pageInfo = new PageInfo<>(spuEntities);
    return  this.setResult(HTTPStatus.OK,pageInfo.getTotal()+"",spuDTOList);
    //return this.setResultSuccess(pageInfo);

}

}
```

### 新增

前台

###### GoodsFrom.vue

```
  <!--商品分类-->
  <v-cascader
      url="category/list"
      required
      showAllLevels
      v-model="goods.categories"
      label="请选择商品分类"/>
```



```
 handler(val) {
        // 判断商品分类是否存在，存在才查询
        if (val && val.length > 0) {
          // 根据分类查询品牌
          this.$http
            .get("brand/getBrandInfoByCategoryId",{
              params:{
              cid:this.goods.categories[2].id
              }
            })
            .then((resp) => {
              this.brandOptions = resp.data.data;
            });
          // 根据分类查询规格参数
          this.$http
            .get("specparam/getSpecParamInfo",{
              params:{
              cid:this.goods.categories[2].id
              }
            })
            .then((resp) => {
              let specs = [];
              let template = [];
              if (this.isEdit){
                specs = JSON.parse(this.goods.spuDetail.genericSpec);
                template = JSON.parse(this.goods.spuDetail.specialSpec);
              }
              // 对特有规格进行筛选
              const arr1 = [];
              const arr2 = [];
              resp.data.data.forEach(({id, name,generic, numeric, unit }) => {
                if(generic){
                  const o = { id, name, numeric, unit};
                  if(this.isEdit){
                    o.v = specs[id];
                  }
                  arr1.push(o)
                }else{
                  const o = {id, name, options:[]};
                  if(this.isEdit){
                    o.options = template[id];
                  }
                  arr2.push(o)
                }
              });
              this.specs = arr1;// 通用规格
              this.specialSpecs = arr2;// 特有规格
            });
```



```
<v-stepper-content step="2">
<v-editor v-model="goods.spuDetail.description" upload-url="/upload"/>
</v-stepper-content>
```

 

```
images: images ? images.map(i => i.data).join(",") : '', // 图片
```

######  Editor.vue

```
this.$http.post(this.uploadUrl, data)
	.then(resp => {
		//修改图片回显的路径
    if (resp.data.data) {
    	this.editor.insertEmbed(this.editor.getSelection().index, 'image',				resp.data.data)
    }
})

```



 BrandService

```
@ApiOperation(value="通过分类id获取品牌")
@GetMapping(value = "brand/getBrandByCategory")
Result<List<BrandEntity>> getBrandByCategory(Integer cid);
```

#### BrandMapper

#	

```
package com.baidu.shop.mapper;

import com.baidu.shop.entity.BrandEntity;
import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.common.Mapper;

import java.util.List;

public interface BrandMapper extends Mapper<BrandEntity> {

    @Select(value = "select * from tb_brand b where b.id in(select cb.brand_id from tb_category_brand cb where cb.category_id=#{cid})")
    List<BrandEntity> getBrandInfoByCategoryId(Integer cid);


}
```

BrandServiceImpl

```
@Override
public Result<BrandEntity> getBrandByCategory(Integer cid) {
if(ObjectUtil.isNotNull(cid)){
List<BrandEntity> list = brandMapper.getBrandByCategory(cid);
return this.setResultSuccess(list);
}
return null;
}
```



SpecificationServiceImpl

```
 @Override
    public Result<List<SpecParamEntity>> getSpecParamInfo(SpecParamDTO specParamDTO) {
        SpecParamEntity specParamEntity = BaiduBeanUtil.copyProperties(specParamDTO, SpecParamEntity.class);
        Example example = new Example(SpecParamEntity.class);
        Example.Criteria criteria = example.createCriteria();

        if(ObjectUtil.isNotNull(specParamDTO.getGroupId())){
            criteria.andEqualTo("groupId",specParamDTO.getGroupId());
        }
        if(ObjectUtil.isNotNull(specParamDTO.getCid())){
            criteria.andEqualTo("cid",specParamDTO.getCid());
        }
        
        List<SpecParamEntity> list = specParamMapper.selectByExample(example);

        return this.setResultSuccess(list);

    }
```

 SpuDetailEntity

```
package com.baidu.shop.entity;

import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;
import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;

/**
 * 2 *@ClassName SpuDetailEntity
 * 3 *@Description: TODO
 * 4 *@Author 王振方
 * 5 *@Date 2021/1/7
 *
 * @Version V1.0
 * 7
 **/
@Data
@Table(name = "tb_spu_detail")
public class SpuDetailEntity{

    @Id
    @ApiModelProperty(value = "spuId主鍵",example = "1")
    @NotNull(message = "spuId不能为空",groups = {MingruiOperation.Update.class})
    private Integer spuId;

    private String description;

    @ApiModelProperty(value = "通用参数")
    @NotEmpty(message = "通用参数不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private String genericSpec;

    @ApiModelProperty(value = "特殊参数")
    @NotEmpty(message = "特殊参数不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private String specialSpec;

    private String packingList;

    private String afterService;



}

```

SkuEntity



```
package com.baidu.shop.entity;

import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModelProperty;
import io.swagger.models.auth.In;
import lombok.Data;

import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;
import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;
import java.util.Date;

/**
 * 2 *@ClassName SkuEntity
 * 3 *@Description: TODO
 * 4 *@Author 王振方
 * 5 *@Date 2021/1/7
 *
 * @Version V1.0
 * 7
 **/

@Data
@Table(name = "tb_sku")
public class SkuEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @ApiModelProperty(value = "sku主鍵",example = "1")
    @NotNull(message = "id不能为空",groups = {MingruiOperation.Update.class})
    private Long id;

    @ApiModelProperty(value = "spuId不能为空",example = "1")
    @NotNull(message = "spuId不能为空",groups = {MingruiOperation.Update.class})
    private Integer spuId;

    @ApiModelProperty(value = "标题")
    @NotEmpty(message = "标题不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private String title;

    @ApiModelProperty(value = "图片")
    private String images;

    @ApiModelProperty(value = " 价格不能为空",example = "1")
    @NotNull(message = " 价格不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private Integer price;

    private String indexes;

    private String ownSpec;

    @ApiModelProperty(value = "enable不能为空",example = "1")
    @NotNull(message = "enable不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private Integer enable;

    private Date createTime;

    private Date lastUpdateTime;


}

```



StockEntity

```
package com.baidu.shop.entity;

import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;
import javax.validation.constraints.NotNull;

/**
 * 2 *@ClassName StockEntity
 * 3 *@Description: TODO
 * 4 *@Author 王振方
 * 5 *@Date 2021/1/7
 *
 * @Version V1.0
 * 7
 **/
@Data
@Table(name = "tb_stock")
public class StockEntity {

    @Id
    @ApiModelProperty(value = "skuId主鍵",example = "1")
    @NotNull(message = "skuId主键不能为空",groups = {MingruiOperation.Update.class})
    private Long skuId;

    private Integer seckillStock;

    private Integer seckillTotal;

    @ApiModelProperty(value = "库存不能为空",example = "1")
    @NotNull(message = "库存不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private Integer stock;

}

```



 SpuDetailDTO

```
package com.baidu.shop.dto;

import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.persistence.Id;
import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;

/**
 * 2 *@ClassName SpuDetailDTO
 * 3 *@Description: TODO
 * 4 *@Author 王振方
 * 5 *@Date 2021/1/7
 *
 * @Version V1.0
 * 7
 **/
@ApiModel(value = "spu大字段数据传输类")
@Data
public class SpuDetailDTO {

    @ApiModelProperty(value = "spu主键",example = "1")
    @NotNull(message = "spuId不能为空",groups = {MingruiOperation.Update.class})
    private Integer spuId;

    @ApiModelProperty(value = "商品描述信息")
    private String description;

    @ApiModelProperty(value = "通用规格参数数据")
    @NotEmpty(message = "通用参数不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private String genericSpec;

    @ApiModelProperty(value = "特有规格参数及可选值信息，json格式")
    @NotEmpty(message = "特殊参数不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private String specialSpec;

    @ApiModelProperty(value = "包装清单")
    private String packingList;

    @ApiModelProperty(value = "售后服务")
    private String afterService;

}

```

 SkuDTO

```
package com.baidu.shop.dto;

import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import jdk.nashorn.internal.ir.CallNode;
import lombok.Data;
import sun.dc.pr.PRError;

import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;
import java.util.Date;

/**
 * 2 *@ClassName skuDTO
 * 3 *@Description: TODO
 * 4 *@Author 王振方
 * 5 *@Date 2021/1/7
 *
 * @Version V1.0
 * 7
 **/
@Data
@ApiModel(value = "sku属性数据传输类")
public class SkuDTO {

    @ApiModelProperty(value = "主键", example = "1")
    @NotNull(message = "id不能为空",groups = {MingruiOperation.Update.class})
    private Long id;

    @ApiModelProperty(value = "spu主键", example = "1")
    @NotNull(message = "spuId不能为空",groups = {MingruiOperation.Update.class})
    private Integer spuId;

    @ApiModelProperty(value = "商品标题")
    @NotEmpty(message = "标题不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private String title;

    @ApiModelProperty(value = "商品的图片，多个图片以‘,’分割")
    private String images;

    @ApiModelProperty(value = "销售价格，单位为分", example = "1")
    @NotNull(message = " 价格不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private Integer price;

    @ApiModelProperty(value = "特有规格属性在spu属性模板中的对应下标组合")
    private String indexes;

    @ApiModelProperty(value = "sku的特有规格参数键值对，json格式，反序列化时请使用 linkedHashMap，保证有序")
    private String ownSpec;

    //注意此处使用boolean值来接,在service中处理一下就可以了
    @ApiModelProperty(value = "是否有效，0无效，1有效", example = "1")
    // @NotNull(message = "enable不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private Boolean enable;

    @ApiModelProperty(value = "添加时间")
    private Date createTime;

    @ApiModelProperty(value = "最后修改时间")
    private Date lastUpdateTime;

    @ApiModelProperty(value = "库存")
    private Integer stock;


}

```

StockDTO

```
package com.baidu.shop.dto;

import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.persistence.Table;
import javax.validation.constraints.NotNull;

/**
 * 2 *@ClassName StockDTO
 * 3 *@Description: TODO
 * 4 *@Author 王振方
 * 5 *@Date 2021/1/7
 *
 * @Version V1.0
 * 7
 **/
@Data
@ApiModel(value = "库数据传输类")
public class StockDTO {

    @ApiModelProperty(value = "sku主键", example = "1")
    @NotNull(message = "skuId主键不能为空",groups = {MingruiOperation.Update.class})
    private Long skuId;

    @ApiModelProperty(value = "可秒杀库存", example = "1")
    private Integer seckillStock;

    @ApiModelProperty(value = "秒杀总数量", example = "1")
    private Integer seckillTotal;

    @ApiModelProperty(value = "库存数量", example = "1")
    @NotNull(message = "库存不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private Integer stock;


}

```

GoodsService

```
@ApiOperation(value = "新建商品")
@PostMapping(value = "goods/add")
Result<JSONObject> saveGoods(@RequestBody SpuDTO spuDTO);

```

```
@Override
public Result<JSONObject> saveGoods(SpuDTO spuDTO) {
	System.out.println(spuDTO);
	return this.setResultSuccess();
}
```

////////////////////////////

 SpuDetailMapper

```
import com.baidu.shop.entity.SpuDetailEntity;
import tk.mybatis.mapper.common.Mapper;

public interface SpuDetailMapper extends Mapper<SpuDetailEntity> {
}
```

  SkuMapper

```
import com.baidu.shop.entity.SkuEntity;
import tk.mybatis.mapper.common.Mapper;
public interface SkuMapper extends Mapper<SkuEntity> {
}
```



 StockMapper

```
public interface StockMapper extends Mapper<StockEntity> {
}

```



GoodsServiceImpl

```
 @Override
    @Transactional
    public Result<JSONObject> saveGoods(SpuDTO spuDTO) {
        System.out.println(spuDTO);
        //新增spu
        final Date date = new Date();
        SpuEntity spuEntity = BaiduBeanUtil.copyProperties(spuDTO, SpuEntity.class);
        spuEntity.setSaleable(1);
        spuEntity.setValid(1);
        spuEntity.setCreateTime(date);
        spuEntity.setLastUpdateTime(date);
        spuMapper.insertSelective(spuEntity);
        //新增spuDetail、
        SpuDetailDTO spuDetail = spuDTO.getSpuDetail();
        SpuDetailEntity spuDetailEntity = BaiduBeanUtil.copyProperties(spuDetail, SpuDetailEntity.class);
        spuDetailEntity.setSpuId(spuEntity.getId());
        spuDetailMapper.insertSelective(spuDetailEntity);
        //新增sku list插入顺序有序 b,a set a,b treeSet b,a

        List<SkuDTO> skus = spuDTO.getSkus();
        skus.stream().forEach(skuDTO ->{
            SkuEntity skuEntity = BaiduBeanUtil.copyProperties(skuDTO, SkuEntity.class);
            skuEntity.setSpuId(spuEntity.getId());
            skuEntity.setCreateTime(date);
            skuEntity.setLastUpdateTime(date);
            skuMapper.insertSelective(skuEntity);

            //新增stock
            StockEntity stockEntity = new StockEntity();
            stockEntity.setSkuId(skuEntity.getId());
            stockEntity.setStock(skuDTO.getStock());
            stockMapper.insertSelective(stockEntity);

        });
```



### 修改

 Goods.vue

```
editItem(item) {
//弹出模态框,页面bug,理论上不应该这么做
this.isEdit = true;
this.show = true;
 //列表中传输过来的数据
let obj = item;
// 查询商品详情
this.$http
.get("/goods/getSpuDetailBydSpu", {
params: {
spuId: item.id,
},
})
.then((resp) => {
//准备分类需要回显的数据
obj.categories = [];//解决子级组件监控undefiend问题
//商品详情
obj.spuDetail = resp.data.data;
//特殊规格数据
obj.spuDetail.specTemplate = resp.data.specialSpec;
//通用规格数据
obj.spuDetail.specifications = resp.data.genericSpec;
//查询sku
this.$http
.get("goods/getSkuBySpuId", {
params: {
spuId: item.id,
},
})
.then((resp) => {
obj.skus = resp.data.data;
//需要回显的数据
this.selectedGoods = obj;//最后再给selectedGoods赋值
})
.catch((error) => console.log(error));
});
},

 
```

GoodsForm.vue

```
 oldGoods: {
      deep: true,
      handler(val) {
        if (!this.isEdit) {
          Object.assign(this.goods, {
            categories: null, // 商品分类信息
            brandId: 0, // 品牌id信息
            title: "", // 标题
            subTitle: "", // 子标题
            spuDetail: {
              packingList: "", // 包装列表
              afterService: "", // 售后服务
              description: "" // 商品描述
            }
          });
          this.specs = [];
          this.specialSpecs = [];
        } else {
          this.goods = Object.deepCopy(val);

          // 先得到分类名称
          const names = val.categoryName.split("/");
          // 组织商品分类数据
         // 先得到分类名称 bug!!!!
          window.setTimeout(() => {
            const names = val.categoryName.split("/");
            // 组织商品分类数据
            this.goods.categories = [
              { id: val.cid1, name: names[0] },
              { id: val.cid2, name: names[1] },
              { id: val.cid3, name: names[2] }
            ];
          },50)

          // 将skus处理成map
          const skuMap = new Map();
          this.goods.skus.forEach(s => {
            skuMap.set(s.indexes, s);
          });
          this.goods.skus = skuMap;
        }
      }
    },
    "goods.categories": {
      deep: true,
      handler(val) {
        // 判断商品分类是否存在，存在才查询
        if (val && val.length > 0) {
          // 根据分类查询品牌
          this.$http
            .get("brand/getBrandInfoByCategoryId",{
              params:{
              cid:this.goods.categories[2].id
              }
            })
            .then((resp) => {
              this.brandOptions = resp.data.data;
            });
          // 根据分类查询规格参数
          this.$http
            .get("specparam/getSpecParamInfo",{
              params:{
              cid:this.goods.categories[2].id
              }
            })
            .then((resp) => {
              let specs = [];
              let template = [];
              if (this.isEdit){
                specs = JSON.parse(this.goods.spuDetail.genericSpec);
                template = JSON.parse(this.goods.spuDetail.specialSpec);
              }
              // 对特有规格进行筛选
              const arr1 = [];
              const arr2 = [];
              resp.data.data.forEach(({id, name,generic, numeric, unit }) => {
                if(generic){
                  const o = { id, name, numeric, unit};
                  if(this.isEdit){
                    o.v = specs[id];
                  }
                  arr1.push(o)
                }else{
                  const o = {id, name, options:[]};
                  if(this.isEdit){
                    o.options = template[id];
                  }
                  arr2.push(o)
                }
              });
              this.specs = arr1;// 通用规格
              this.specialSpecs = arr2;// 特有规格
            });
        }
      }
    }
  },
```

#### GoodsService

```
    @ApiOperation(value = "通过spuid查询spuDetail信息")
    @GetMapping(value = "/goods/getSpuDetailBySpuId")
    Result<SpuDetailEntity> getSpuDetailBySpuId(Integer spuId);

    @ApiOperation(value = "通过spuId查询skus的信息")
    @GetMapping(value = "/goods/getSkusBySpuId")
    Result<SkuDTO> getSkusBySpuId(Integer spuId);
```

##### SkuMapper

```
package com.baidu.shop.mapper;

import com.baidu.shop.dto.SkuDTO;
import com.baidu.shop.entity.SkuEntity;
import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.additional.idlist.DeleteByIdListMapper;
import tk.mybatis.mapper.common.Mapper;
import tk.mybatis.mapper.common.special.InsertListMapper;

import java.util.List;

public interface SkuMapper extends Mapper<SkuEntity> , InsertListMapper<SkuMapper> , DeleteByIdListMapper<SkuEntity,Long> {
    @Select(value = "select k.*,t.stock from tb_sku k, tb_stock t where k.id = t.sku_id and k.spu_id = #{spuId}")
    List<SkuDTO> getSkusAndStockBySpuId(Integer spuId);

}

```

##### GoodsServiceImpl

```
 @Override
    public Result<SpuDetailEntity> getSpuDetailBySpuId(Integer spuId) {
        SpuDetailEntity spuDetailEntity = 		spuDetailMapper.selectByPrimaryKey(spuId);
        return this.setResultSuccess(spuDetailEntity);
    }

    @Override
    public Result<SkuDTO> getSkusBySpuId(Integer spuId) {
        List<SkuDTO> skusAndStockBySpuId = 			skuMapper.getSkusAndStockBySpuId(spuId);
        return this.setResultSuccess(skusAndStockBySpuId);
    }
```



### 删除

#####  Goods.vue

```
deleteItem(id) {
        this.$message.confirm('此操作将永久删除该商品, 是否继续?')
          .then(() => {
            // 发起删除请求
            this.$http.delete("/goods/delete?spuId=" + id)
              .then(() => {
                // 删除成功，重新加载数据
                this.getDataFromApi();
                this.$message.info('删除成功!');
              })
          })
          .catch(() => {
            this.$message.info('已取消删除');
          });

      },
```

 GoodsService



```
    @ApiOperation(value = "删除商品")
    @DeleteMapping(value = "goods/del")
    Result<JSONObject> delGoods(Integer spuId);
```

GoodsServiceImpl

```
 @Transactional
    @Override
    public Result<JSONObject> GoodsDelete(Integer spuId) {
        //删除spu
        spuMapper.deleteByPrimaryKey(spuId);
        //删除spuDetail
        spuDetailMapper.deleteByPrimaryKey(spuId);
        //删除skus和stock

        //通过spuId 查询sku信息
        final Example example = new Example(SkuEntity.class);
        example.createCriteria().andEqualTo("spuId",spuId);
        final List<SkuEntity> skuEntities = skuMapper.selectByExample(example);
        //得到skuId集合
        final List<Long> skuIdList = skuEntities.stream().map(skuEntity -> skuEntity.getId()).collect(Collectors.toList());
        skuMapper.deleteByIdList(skuIdList);
        stockMapper.deleteByIdList(skuIdList);

        return  this.setResultSuccess();

    }
```





